<!DOCTYPE html>
<html>
  <head>
    <title>PayPal Checkout</title>
    <script src="https://www.paypal.com/sdk/js?client-id=AY8qqs3ey2ppkMZgRKMkiNdKDAKEjxjihViL55pGFdibxCk2gnN0glRr9D8EKS6nGKNEXGKx0gIJptzc&currency=EUR"></script>
  </head>
  <body>
    <div id="paypal-button-container"></div>

    <script>
      let bookingData = null;
      let buttonsRendered = false;

      function renderButtons() {
        if (!bookingData || buttonsRendered) return;
        buttonsRendered = true;

        const { amount, bookingNumber } = bookingData;

        paypal.Buttons({
          createOrder: function (data, actions) {
            return actions.order.create({
              purchase_units: [{
                amount: { value: amount }
              }]
            });
          },
          onApprove: function (data, actions) {
            return actions.order.capture().then(function (details) {
              window.parent.postMessage({ status: "success", bookingNumber }, "*");
            });
          },
          onError: function (err) {
            window.parent.postMessage({ status: "error", message: err.message }, "*");
          }
        }).render('#paypal-button-container');
      }

      window.addEventListener("message", (event) => {
        if (!event.data?.amount) return;

        bookingData = {
          amount: event.data.amount,
          bookingNumber: event.data.bookingNumber
        };

        renderButtons();
      });

      // Falls die Nachricht bereits vor addEventListener ankam (selten), 1 Sekunde spÃ¤ter erneut versuchen
      setTimeout(() => {
        if (!buttonsRendered) renderButtons();
      }, 1000);
    </script>
  </body>
</html>
